<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Jam Buddy ðŸŽ¹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@magenta/music@1.23.1/dist/magentamusic.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: #222;
            color: white;
        }

        #status {
            margin-bottom: 20px;
            color: #aaa;
        }

        .piano {
            display: flex;
            gap: 10px;
        }

        .key {
            width: 60px;
            height: 200px;
            background: white;
            border-radius: 0 0 5px 5px;
            cursor: pointer;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            color: black;
            font-weight: bold;
            padding-bottom: 10px;
            transition: background 0.1s;
        }

        .key:active,
        .key.active {
            background: #ffd700;
            transform: translateY(2px);
        }

        .key.ai-playing {
            background: #00ffcc;
            box-shadow: 0 0 15px #00ffcc;
        }

        button#start-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
    </style>
</head>

<body>

    <div id="status">Click "Start Audio" to begin...</div>
    <button id="start-btn">Start Audio Engine</button>

    <div class="piano" id="piano-container" style="display:none;">
    </div>

    <script>
        // --- 1. SETUP ---
        const synth = new Tone.PolySynth(Tone.Synth).toDestination();
        // Using MusicRNN (specifically the 'improv' model which is good for chord progressions)
        const model = new mm.MusicRNN('https://storage.googleapis.com/magentadata/js/checkpoints/music_rnn/chord_pitches_improv');

        let isAIThinking = false;
        let userNotes = []; // Stores the notes you play
        let lastNoteTime = 0;
        const INACTIVITY_THRESHOLD = 2000; // 2 seconds of silence triggers the AI
        let inactivityTimer;

        // --- 2. INITIALIZATION ---
        document.getElementById('start-btn').addEventListener('click', async () => {
            await Tone.start();
            document.getElementById('status').innerText = "Loading AI Model... (this takes a few seconds)";

            // Initialize the AI Model
            await model.initialize();

            document.getElementById('status').innerText = "System Ready! Play a melody (A-K keys).";
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('piano-container').style.display = 'flex';
            createKeys();
            setupKeyboardListener();
        });

        // --- 3. PIANO LOGIC ---
        const NOTES = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4', 'C5'];
        const MIDI_NUMS = [60, 62, 64, 65, 67, 69, 71, 72];
        const KEY_MAP = { 'a': 0, 's': 1, 'd': 2, 'f': 3, 'g': 4, 'h': 5, 'j': 6, 'k': 7 };

        function createKeys() {
            const container = document.getElementById('piano-container');
            NOTES.forEach((note, index) => {
                const div = document.createElement('div');
                div.className = 'key';
                div.id = `key-${MIDI_NUMS[index]}`;
                div.innerText = note;
                div.onmousedown = () => playNote(index);
                container.appendChild(div);
            });
        }

        function setupKeyboardListener() {
            window.addEventListener('keydown', (e) => {
                if (KEY_MAP[e.key] !== undefined && !e.repeat) {
                    playNote(KEY_MAP[e.key]);
                }
            });
        }

        function playNote(index, isAI = false) {
            const note = NOTES[index];
            const midi = MIDI_NUMS[index];

            // Play sound
            synth.triggerAttackRelease(note, "8n");

            // Visual feedback
            const keyDiv = document.getElementById(`key-${midi}`);
            if (keyDiv) {
                const activeClass = isAI ? 'ai-playing' : 'active';
                keyDiv.classList.add(activeClass);
                setTimeout(() => keyDiv.classList.remove(activeClass), 200);
            }

            // If HUMAN played this, record it and reset the AI timer
            if (!isAI) {
                clearTimeout(inactivityTimer);

                // Record note for Magenta (needs pitch + quantized time steps)
                // Ideally we'd use exact timing, but for this simple MVP we just push pitches
                userNotes.push({
                    pitch: midi,
                    startTime: Tone.now(),
                    endTime: Tone.now() + 0.5
                });

                // If user stops playing for 2s, trigger AI
                inactivityTimer = setTimeout(triggerAIResponse, INACTIVITY_THRESHOLD);
            }
        }

        // --- 4. THE AI BRAIN ---
        async function triggerAIResponse() {
            if (userNotes.length === 0 || isAIThinking) return;
            isAIThinking = true;
            document.getElementById('status').innerText = "AI is listening and jamming back...";

            // 1. Convert user notes to a NoteSequence (Magenta's format)
            // We limit to the last 10 notes to keep it relevant
            const inputSequence = {
                notes: userNotes.slice(-10).map((n, i) => ({
                    pitch: n.pitch,
                    startTime: i * 0.5,
                    endTime: (i * 0.5) + 0.5
                })),
                totalTime: userNotes.length * 0.5,
                quantizationInfo: { stepsPerQuarter: 4 }
            };

            try {
                // 2. Ask AI to continue the sequence
                // "20" is how many steps (notes) to generate
                const result = await model.continueSequence(inputSequence, 20, 1.1);

                // 3. Play back the AI's jazz solo
                result.notes.forEach((note, i) => {
                    setTimeout(() => {
                        // Find the closest index in our scale to map it back to our keys
                        // (Magenta might generate sharps/flats we don't have on screen)
                        const closestMidi = MIDI_NUMS.reduce((prev, curr) =>
                            Math.abs(curr - note.pitch) < Math.abs(prev - note.pitch) ? curr : prev
                        );
                        const index = MIDI_NUMS.indexOf(closestMidi);
                        if (index !== -1) playNote(index, true);
                    }, i * 300); // Play one note every 300ms
                });

                // Reset after playing
                setTimeout(() => {
                    userNotes = [];
                    isAIThinking = false;
                    document.getElementById('status').innerText = "Your turn! Play something.";
                }, result.notes.length * 300);

            } catch (e) {
                console.error(e);
                isAIThinking = false;
            }
        }
    </script>
</body>

</html>